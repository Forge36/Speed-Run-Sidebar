<!doctype html>
<html>
<head>
    <title>Track Select Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #c61d1d;
            color: white;
            font-family: 'Lucida Console';
        }

        .sidebar {
            font-size: 40px;
        }
    </style>
    <script>
        const socket = new WebSocket("wss://" + location.host + "/controller");
        // Sample response to avoid unecessarily pinging source server.
        // In practice this can probably be cached to once per week/month
        // and a manual "update time" button could avoid any extra calls
        const response = {
            "data": {
                "times": [{
                    "id": 105674,
                    "playerId": 1345,
                    "ntscTime": 105.68,
                    "palTime": 127.07,
                    "trackId": 1,
                    "typeId": 0,
                    "region": "NTSC",
                    "video": null,
                    "comment": null,
                    "submittedAt": "2021-10-09T17:12:14.000Z",
                    "submittedBy": null,
                    "approvedAt": null,
                    "approvedBy": null,
                    "status": "Approved",
                    "rejectionReason": null,
                    "discordId": null,
                    "deadVideo": 0,
                    "trackName": "Luigi Raceway",
                    "trackAbbr": "LR",
                    "typeName": "3lap",
                    "prwr": 0.926812,
                    "standard": {
                        "name": "Advanced D",
                        "points": 39
                    }
                    ,
                    "rank": 1049
                },
                {
                    "id": 115881,
                    "playerId": 1345,
                    "ntscTime": 34.82,
                    "palTime": 41.87,
                    "trackId": 1,
                    "typeId": 1,
                    "region": "NTSC",
                    "video": null,
                    "comment": null,
                    "submittedAt": "2022-08-14T21:28:08.000Z",
                    "submittedBy": null,
                    "approvedAt": null,
                    "approvedBy": null,
                    "status": "Approved",
                    "rejectionReason": null,
                    "discordId": null,
                    "deadVideo": 0,
                    "trackName": "Luigi Raceway",
                    "trackAbbr": "LR",
                    "typeName": "flap",
                    "prwr": 0.89754,
                    "standard": {
                        "name": "Apprentice B",
                        "points": 47
                    }
                    ,
                    "rank": 1075
                },
                {
                    "id": 115882,
                    "playerId": 1345,
                    "ntscTime": 80.19,
                    "palTime": 96.42,
                    "trackId": 2,
                    "typeId": 0,
                    "region": "NTSC",
                    "video": null,
                    "comment": null,
                    "submittedAt": "2022-08-14T21:28:08.000Z",
                    "submittedBy": null,
                    "approvedAt": null,
                    "approvedBy": null,
                    "status": "Approved",
                    "rejectionReason": null,
                    "discordId": null,
                    "deadVideo": 0,
                    "trackName": "Moo Moo Farm",
                    "trackAbbr": "MMF",
                    "typeName": "3lap",
                    "prwr": 0.890583,
                    "standard": {
                        "name": "Advanced A",
                        "points": 36
                    }
                    ,
                    "rank": 844
                },
                ]
            }
        };

        // This script is loading and running immediately. Before elements are available.
        // Delaying rending to avoid extra script loading is a cheap (lazy) way to keep the controller a single file
        setTimeout(function () {

            const trackSelector = document.getElementById("trackSelector");
            const processResponse = function () {
                // the response is an arrary of times. My personal preferrence is to keep both types of times displayed at once.
                // This makes a key:dual-value which needs to be transformed from the original data.

                const tracksData = [];
                response.data.times.forEach(time => {
                    if (!tracksData[time.trackId]) {
                        tracksData[time.trackId] = {
                            trackName: time.trackName,
                        };
                    }

                    tracksData[time.trackId][time.typeName] = {
                        // TODO: to time is in seconds. Minutes'Seconds"Thousanths is desired need to write a formatter function.
                        time: time.ntscTime, // I run ntsc so I'll normalize this for dispaly
                    };
                });

                return tracksData;
            }
            const buildSelector = function (trackData) {
                trackData.forEach(track => {
                    const opt = document.createElement("option");
                    opt.value = track.trackId;
                    opt.text = track.trackName;
                    trackSelector.add(opt);
                });
            }
            const tracksData = processResponse(response);
            buildSelector(tracksData);
            trackSelector.firstChild.selected = true;

            var track = tracksData[1];
            var newState = { track: track.trackName, pb: track["3lap"].time, fl: track["flap"].time };
            if (socket.readyState == socket.OPEN) {
                socket.send(JSON.stringify(newState));
            }
            else {
                socket.onopen = function () {
                    socket.send(JSON.stringify(newState));
                };
            }
        }, 50);
    </script>
</head>
<body>
    <div>
        Track: <select id="trackSelector"></select>
    </div>
</body>
</html>
